extends layout

block head
  link(rel='stylesheet', href='/stylesheets/server_metrics.css')

block content
  h1(id='server-metrics-title') Server Metrics for #{server} on #{date} 

  #cpu-metrics

block footer
  script(src='/javascripts/server_metrics.js')
  script(src='/flot/jquery.flot.js')
  script(src='/flot/jquery.flot.time.js')
  script(src='/flot/jquery.flot.selection.js')
  script(src='/flot/jquery.flot.crosshair.js')
  script.
    var data, options, plot, targetDiv;
    data=#{metrics};

    options= {
      xaxis: {mode: 'time',minTickSize: [1, 'hour']},
      crosshair: { mode: 'xy'},
      selection: { mode: 'x'},
      grid: {hoverable: true, clickable: true}
    };  

    targetDiv=$('#cpu-metrics');

    targetDiv.bind("plotselected", function (event, ranges) {
      $.each(plot.getXAxes(), function(_, axis) {
        var opts = axis.options;
        opts.min = ranges.xaxis.from;
        opts.max = ranges.xaxis.to;
      });
      plot.setupGrid();
      plot.draw();
      plot.clearSelection();
    });

    $("<div id='tooltip'></div>").css({
      position: "absolute",
      display: "none",
      border: "1px solid #fdd",
      padding: "2px",
      "background-color": "#fee",
      opacity: 0.80
    }).appendTo("body");

    targetDiv.bind("plothover", function (event, pos, item) {
      if (item) {
        var x = item.datapoint[0].toFixed(2),
          y = item.datapoint[1].toFixed(2);

        $("#tooltip").html(y + " , " + x)
          .css({top: item.pageY+10, left: item.pageX+10})
          .fadeIn(200);
      } else {
        $("#tooltip").hide();
      }
    });

    targetDiv.dblclick(function() {
      alert('Show process metrics');
    });

    plot=$.plot(targetDiv, [{data: data, label: 'CPU Utilisation'}], options);